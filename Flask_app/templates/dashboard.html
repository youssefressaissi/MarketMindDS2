{# flask_app/templates/dashboard.html #}
{% extends "base.html" %} {# Assumes base.html provides structure and necessary CSS/JS #}

{% block title %}Dashboard - MarketMind AI{% endblock %}

{% block content %}
{# Main dashboard container - this fills the 'main#main-content' block from base.html #}
<div class="relative flex h-full bg-slate-50 overflow-hidden">

  <!-- **** SHARED HIDDEN INPUT FOR IMAGE STATE **** -->
  <!-- This one is primarily for JS to read/write the shared state -->
  <input type="hidden" id="shared_init_image_base64" value="{{ last_init_image_base64 | default('', true) }}">
  <!-- ********************************************* -->


  <!-- **** SLIDE-OUT Left Sidebar (Conversations) **** -->
  <aside id="businesses-sidebar" class="absolute top-0 left-0 z-30 h-full w-72 flex-shrink-0 bg-slate-100 border-r border-slate-300 shadow-lg flex flex-col transition-transform duration-300 ease-in-out transform -translate-x-full">
    {# Sidebar Header #}
    <div class="p-4 border-b border-slate-200 flex-shrink-0 flex justify-between items-center">
        <h2 class="text-lg font-semibold text-slate-700">My Business Chats</h2>
        <button id="close-businesses-btn" title="Close Sidebar" class="text-slate-500 hover:text-red-600 p-1.5 rounded-md hover:bg-slate-200 transition duration-150 ease-in-out">
           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /> </svg>
        </button>
    </div>
    {# New Chat Button #}
    <div class="p-4 flex-shrink-0">
        <a href="{{ url_for('views.dashboard') }}" class="flex items-center justify-center w-full bg-primary hover:bg-primary-dark text-white font-semibold py-2.5 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 text-sm transition duration-150 ease-in-out shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /> </svg>
            New Chat
        </a>
    </div>
    {# Conversation List #}
    <nav class="flex-grow overflow-y-auto p-4 space-y-1 scrollbar-thin scrollbar-thumb-slate-400 scrollbar-track-slate-200">
      {% if all_conversations %}
        {% for convo in all_conversations %}
            <a href="{{ url_for('views.dashboard', conversation_id=convo._id) }}" class="block px-3 py-2 rounded-md text-sm font-medium truncate transition duration-150 ease-in-out {% if active_conversation_id and convo._id|string == active_conversation_id|string %} bg-indigo-100 text-primary font-semibold {% else %} text-slate-600 hover:bg-slate-200 hover:text-slate-800 {% endif %}">
                {{ convo.title | default('Untitled Chat', true) }}
            </a>
        {% endfor %}
      {% else %}
        <p class="text-slate-500 italic text-sm px-3 py-2">Start your first chat!</p>
      {% endif %}
    </nav>
  </aside>
  <!-- **** End Left Sidebar **** -->

  <!-- **** SLIDE-OUT Right Image Panel **** -->
  <aside id="image-panel" class="absolute top-0 right-0 z-20 h-full w-96 flex-shrink-0 bg-white border-l border-slate-300 shadow-lg flex flex-col transition-transform duration-300 ease-in-out transform translate-x-full scrollbar-thin scrollbar-thumb-slate-300 scrollbar-track-slate-100 overflow-y-auto">
      {# Header #}
      <div class="p-4 sm:p-6 border-b border-slate-200 flex-shrink-0 flex justify-between items-center sticky top-0 bg-white z-10">
        <h2 class="text-lg font-semibold text-slate-700">Visual Generation</h2>
        <button id="close-image-btn" title="Close Image Panel" class="text-slate-500 hover:text-red-600 p-1.5 rounded-md hover:bg-slate-200 transition duration-150 ease-in-out">
           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /> </svg>
        </button>
      </div>
      {# Content - Image Generation Form and Display #}
      <form id="image-gen-form" action="{{ url_for('views.generate_image') }}" method="POST" class="p-4 sm:p-6 flex-shrink-0">
          {# Hidden fields to pass ALL current state back to the server #}
          <input type="hidden" name="conversation_id" value="{{ active_conversation_id | default('', true) }}">
          <input type="hidden" name="topic" value="{{ last_topic | default('', true) }}">
          <input type="hidden" name="audio_text" value="{{ last_audio_text | default('', true) }}">
          <input type="hidden" name="language_code" value="{{ last_language_code | default('en', true) }}">
          <input type="hidden" name="speaker_id" value="{{ last_speaker_id | default('', true) }}">
          <input type="hidden" name="generated_audio_base64" value="{{ generated_audio_base64 | default('', true) }}">
          <input type="hidden" name="video_prompt" value="{{ last_video_prompt | default('', true) }}">
          <input type="hidden" name="video_status_message" value="{{ video_status_message | default('', true) }}">
          {# This form needs to submit the shared image state if it's an img2img operation #}
          <input type="hidden" id="image_form_init_image_base64" name="init_image_base64" value="{{ last_init_image_base64 | default('', true) }}">

          {# Text Prompt Input #}
          <div class="mb-4">
              <label for="image_prompt" class="block text-slate-700 text-sm font-semibold mb-2"> Image Prompt </label>
              <textarea id="image_prompt" name="image_prompt" rows="4" required class="shadow-sm appearance-none border border-slate-300 rounded-lg w-full py-2 px-3 text-gray-700 text-sm leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-y" placeholder="Describe the visual you want...">{{ last_image_prompt | default('', true) }}</textarea>
              <p class="text-xs text-slate-500 mt-1">Describe the image (required).</p>
          </div>

          {# Input Image Section (Upload and Preview - Affects Shared State) #}
          <div class="mb-4 border border-slate-200 rounded-lg p-3 bg-slate-50">
              <label for="init_image_upload" class="block text-slate-700 text-sm font-semibold mb-2">Input Image (Optional for Img2Img / Required for Img2Vid)</label>
              <input type="file" id="init_image_upload" name="init_image_upload_file" accept="image/png, image/jpeg, image/webp" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100 mb-2 cursor-pointer"/>
              <div id="init-image-preview-container" class="mt-2 {% if not last_init_image_base64 %}hidden{% endif %}">
                  <p class="text-xs text-slate-600 mb-1">Current Input Image:</p>
                  <div class="relative group w-32 h-32 border border-slate-300 rounded overflow-hidden bg-white flex items-center justify-center">
                      <img id="init-image-preview" src="{{ 'data:image/png;base64,' ~ last_init_image_base64 if last_init_image_base64 else '#' }}" alt="Input image preview" class="w-full h-full object-contain {% if not last_init_image_base64 %}hidden{% endif %}">
                       <button type="button" id="clear-init-image" title="Clear Input Image" class="absolute top-1 right-1 bg-red-600 hover:bg-red-700 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 focus:opacity-100 transition-opacity shadow-sm">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                       </button>
                  </div>
              </div>
              <p class="text-xs text-slate-500 mt-1">Upload an image OR use one generated below. This image will be used for Img2Img or Video Generation.</p>
          </div>
          {# Submit Button for Image Generation #}
          <button type="submit" id="image-submit-button" class="w-full flex items-center justify-center bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2.5 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition duration-150 ease-in-out shadow-sm text-sm {% if not active_conversation_id %} disabled bg-gray-400 cursor-not-allowed {% endif %}" {% if not active_conversation_id %} title="Please select or start a business chat first." {% endif %}>
    <span class="button-text">Generate Image</span>
    {# The loading indicator div for THIS button #}
    <span id="image-loading-indicator" class="loading-spinner hidden ml-2"><div class="spinner spinner-purple"></div></span>
</button>
      </form>
      {# --- Image Result Display Area --- #}
      <div class="mt-4 p-4 sm:p-6 text-center flex flex-col border-t border-slate-200 min-h-[200px] flex-grow">
           {% if generated_image_base64 %}
               {# Input Image Used (if different from output) #}
               {% if last_init_image_base64 and last_init_image_base64 != generated_image_base64 %}
                <div class="mb-4 flex-shrink-0">
                    <h3 class="text-sm font-semibold text-slate-600 mb-2">Input Image Used:</h3>
                    <div class="inline-block border border-slate-200 rounded p-1 bg-slate-100 shadow-sm">
                        <img src="data:image/png;base64,{{ last_init_image_base64 }}" alt="Input image used" class="max-w-xs h-auto mx-auto rounded" style="max-height: 150px;">
                    </div>
                </div>
               {% endif %}

               {# Generated Image #}
               <h3 class="text-base font-semibold text-slate-700 mb-3 flex-shrink-0">Generated Visual:</h3>
               <div class="flex-shrink-0 mb-4 bg-slate-100 p-2 rounded-lg border border-slate-200 shadow-sm relative group">
                   <img src="data:image/png;base64,{{ generated_image_base64 }}" alt="Generated Image" class="max-w-full h-auto mx-auto rounded shadow">
                   {# --- Button to trigger video from this image --- #}
                   <button type="button" onclick="triggerVideoFromImage('{{ generated_image_base64 | escape }}')" title="Use This Image for Video Generation" class="absolute bottom-2 right-2 bg-blue-500 hover:bg-blue-600 text-white p-1.5 rounded-full shadow-md opacity-0 group-hover:opacity-100 focus:opacity-100 transition-opacity duration-150 ease-in-out">
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /> </svg>
                   </button>
               </div>
               {# Prompts Used #}
               <div class="text-xs text-slate-600 text-left bg-slate-100 p-3 rounded-md border border-slate-200 space-y-1 flex-shrink-0">
                   <p><strong>Original Input:</strong><br> <code class="block bg-white p-1 rounded border text-slate-800 break-words max-h-16 overflow-y-auto">{{ last_image_prompt }}</code> </p>
                   {% if last_refined_prompt and last_refined_prompt != last_image_prompt %}
                   <p class="border-t border-slate-200 pt-1"><strong>Prompt Used:</strong><br> <code class="block bg-white p-1 rounded border text-slate-800 break-words max-h-16 overflow-y-auto">{{ last_refined_prompt }}</code> </p>
                   {% elif last_image_prompt %}
                   <p class="border-t border-slate-200 pt-1"><strong>Prompt Used:</strong><br> <code class="block bg-white p-1 rounded border text-slate-800 break-words max-h-16 overflow-y-auto">{{ last_image_prompt }}</code> </p>
                   {% endif %}
               </div>
           {# Show current input image if no generation happened but one exists #}
           {% elif last_init_image_base64 %}
                <div class="mb-4 flex-shrink-0">
                    <h3 class="text-sm font-semibold text-slate-600 mb-2">Current Input Image:</h3>
                    <div class="inline-block border border-slate-200 rounded p-1 bg-slate-100 shadow-sm relative group">
                        <img src="data:image/png;base64,{{ last_init_image_base64 }}" alt="Input image" class="max-w-xs h-auto mx-auto rounded" style="max-height: 200px;">
                        {# --- Button to trigger video from this uploaded/existing image --- #}
                        <button type="button" onclick="triggerVideoFromImage('{{ last_init_image_base64 | escape }}')" title="Use This Image for Video Generation" class="absolute bottom-2 right-2 bg-blue-500 hover:bg-blue-600 text-white p-1.5 rounded-full shadow-md opacity-0 group-hover:opacity-100 focus:opacity-100 transition-opacity duration-150 ease-in-out">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /> </svg>
                       </button>
                    </div>
                </div>
           {% elif image_error %}
               <div class="flex-grow flex items-center justify-center text-red-600 italic text-sm">Image generation failed. See error below.</div>
           {% else %}
               <div class="flex-grow flex items-center justify-center text-slate-500 italic text-sm">Generated or uploaded input image will appear here.</div>
           {% endif %}
           {# Image Error Display #}
           {% if image_error %}
           <div class="mt-4 p-3 bg-red-50 border border-red-300 text-red-800 rounded-md text-sm flex-shrink-0" role="alert">
               <strong class="font-semibold">Image Generation Error:</strong>
               <span class="block mt-1 whitespace-pre-wrap">{{ image_error }}</span>
           </div>
           {% endif %}
      </div>
  </aside>
  <!-- **** End Right Image Panel **** -->

  <!-- **** SLIDE-OUT Right Audio Panel **** -->
  <aside id="audio-panel" class="absolute top-0 right-0 z-10 h-full w-96 flex-shrink-0 bg-white border-l border-slate-300 shadow-lg flex flex-col transition-transform duration-300 ease-in-out transform translate-x-full scrollbar-thin scrollbar-thumb-slate-300 scrollbar-track-slate-100 overflow-y-auto">
       {# Header #}
       <div class="p-4 sm:p-6 border-b border-slate-200 flex-shrink-0 flex justify-between items-center sticky top-0 bg-white z-10">
        <h2 class="text-lg font-semibold text-slate-700">Audio Generation (TTS)</h2>
        <button id="close-audio-btn" title="Close Audio Panel" class="text-slate-500 hover:text-red-600 p-1.5 rounded-md hover:bg-slate-200 transition duration-150 ease-in-out">
           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /> </svg>
        </button>
      </div>
      {# Content #}
      <form id="audio-gen-form" action="{{ url_for('views.generate_audio') }}" method="POST" class="p-4 sm:p-6 flex-shrink-0">
           {# Hidden fields #}
           <input type="hidden" name="conversation_id" value="{{ active_conversation_id | default('', true) }}">
           <input type="hidden" name="topic" value="{{ last_topic | default('', true) }}">
           <input type="hidden" name="image_prompt" value="{{ last_image_prompt | default('', true) }}">
           <input type="hidden" name="last_refined_prompt" value="{{ last_refined_prompt | default('', true) }}">
           <input type="hidden" name="generated_image_base64" value="{{ generated_image_base64 | default('', true) }}">
           <input type="hidden" name="video_prompt" value="{{ last_video_prompt | default('', true) }}">
           <input type="hidden" name="video_status_message" value="{{ video_status_message | default('', true) }}">
           <input type="hidden" id="audio_form_init_image_base64" name="last_init_image_base64" value="{{ last_init_image_base64 | default('', true) }}"> {# Carries shared image state for the form #}


           {# Language #}
           <div class="mb-4">
                <label for="language_code" class="block text-slate-700 text-sm font-semibold mb-2"> Language: </label>
                <select id="language_code" name="language_code" required class="shadow-sm appearance-none border border-slate-300 rounded-lg w-full py-2 px-3 text-gray-700 text-sm leading-tight focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent bg-white">
                    {% for code, name in supported_languages.items() %}
                        <option value="{{ code }}" {% if code == last_language_code %}selected{% endif %}>{{ name }} ({{ code }})</option>
                    {% endfor %}
                </select>
           </div>
           {# Speaker #}
           <div class="mb-4">
                <label for="speaker_id" class="block text-slate-700 text-sm font-semibold mb-2"> Speaker Voice: </label>
                <select id="speaker_id" name="speaker_id" required class="shadow-sm appearance-none border border-slate-300 rounded-lg w-full py-2 px-3 text-gray-700 text-sm leading-tight focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent bg-white {% if not available_speakers %} bg-slate-100 text-slate-500 cursor-not-allowed {% endif %}" {% if not available_speakers %}disabled{% endif %}>
                    {% if available_speakers %}
                        {% for speaker in available_speakers %}
                            <option value="{{ speaker }}" {% if speaker == last_speaker_id %}selected{% endif %}> {{ speaker.replace('_', ' ').title() }} </option>
                        {% endfor %}
                    {% else %}
                        <option value="" disabled selected>No Speakers Found/Loaded</option>
                    {% endif %}
                </select>
                {% if available_speakers %}
                <p class="text-xs text-slate-500 mt-1">Select a voice from your './xtts/speakers' folder.</p>
                {% else %}
                <p class="text-xs text-red-600 mt-1">No speakers loaded. Check './xtts/speakers' and TTS service.</p>
                {% endif %}
           </div>
           {# Text #}
           <div class="mb-4">
                <label for="audio_text" class="block text-slate-700 text-sm font-semibold mb-2"> Text to Speak: </label>
                <textarea id="audio_text" name="audio_text" rows="4" required class="shadow-sm appearance-none border border-slate-300 rounded-lg w-full py-2 px-3 text-gray-700 text-sm leading-tight focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent resize-y" placeholder="Enter text for the voiceover...">{{ last_audio_text | default('', true) }}</textarea>
                <p class="text-xs text-slate-500 mt-1">Use text from chat or write your own script.</p>
           </div>
           {# Submit #}
           <button type="submit" id="audio-submit-button" class="w-full flex items-center justify-center text-white font-semibold py-2.5 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition duration-150 ease-in-out shadow-sm text-sm {% if not active_conversation_id or not available_speakers %} bg-gray-400 cursor-not-allowed {% else %} bg-teal-600 hover:bg-teal-700 {% endif %}" {% if not active_conversation_id or not available_speakers %} disabled {% endif %} title="{% if not active_conversation_id %}Please select or start a business chat first.{% elif not available_speakers %}No speakers available for generation.{% else %}Generate Audio{% endif %}">
    <span class="button-text">Generate Audio</span>
    <span id="audio-loading-indicator" class="loading-spinner hidden ml-2"><div class="spinner spinner-teal"></div></span>
</button>
      </form>
      {# Result Area #}
      <div class="mt-4 p-4 sm:p-6 text-center flex flex-col border-t border-slate-200 min-h-[150px] flex-grow">
           {% if generated_audio_base64 %}
               <h3 class="text-base font-semibold text-slate-700 mb-3 flex-shrink-0">Generated Audio:</h3>
               <div class="flex-shrink-0 mb-4 bg-slate-100 p-2 rounded-lg border border-slate-200 text-center">
                   <audio controls class="w-full h-10 mb-2">
                       <source src="data:audio/wav;base64,{{ generated_audio_base64 }}" type="audio/wav">
                       Your browser does not support the audio element.
                   </audio>
                   {% set unique_id = active_conversation_id[:8] if active_conversation_id else range(1, 1000) | random %}
                   <a href="data:audio/wav;base64,{{ generated_audio_base64 }}" download="generated_audio_{{ unique_id }}_{{ range(1, 10000) | random }}.wav" class="inline-block text-xs bg-slate-200 hover:bg-slate-300 text-slate-700 px-3 py-1.5 rounded-md" title="Download WAV file">
                        Download Audio File
                    </a>
               </div>
               <div class="text-xs text-slate-600 text-left bg-slate-100 p-3 rounded-md border border-slate-200 space-y-1 flex-shrink-0">
                   <p><strong>Text Used:</strong><br> <code class="block bg-white p-1 rounded border text-slate-800 break-words">{{ last_audio_text }}</code> </p>
                   <p class="border-t border-slate-200 pt-1"><strong>Settings:</strong> Lang: {{ last_language_code }}, Speaker: {{ last_speaker_id.replace('_', ' ').title() if last_speaker_id else 'N/A' }}</p>
               </div>
           {% elif audio_error %}
               <div class="flex-grow flex items-center justify-center text-red-600 italic text-sm">Audio generation failed. See error below.</div>
           {% else %}
               <div class="flex-grow flex items-center justify-center text-slate-500 italic text-sm">Generated audio player will appear here.</div>
           {% endif %}
           {% if audio_error %}
           <div class="mt-4 p-3 bg-red-50 border border-red-300 text-red-800 rounded-md text-sm flex-shrink-0" role="alert">
               <strong class="font-semibold">Audio Generation Error:</strong>
               <span class="block mt-1">{{ audio_error }}</span>
           </div>
           {% endif %}
      </div>
  </aside>
  <!-- **** End Right Audio Panel **** -->

  <!-- **** SLIDE-OUT Right Video Panel **** -->
  <aside id="video-panel" class="absolute top-0 right-0 z-10 h-full w-96 flex-shrink-0 bg-white border-l border-slate-300 shadow-lg flex flex-col transition-transform duration-300 ease-in-out transform translate-x-full scrollbar-thin scrollbar-thumb-slate-300 scrollbar-track-slate-100 overflow-y-auto">
      {# Header #}
       <div class="p-4 sm:p-6 border-b border-slate-200 flex-shrink-0 flex justify-between items-center sticky top-0 bg-white z-10">
        <h2 class="text-lg font-semibold text-slate-700">Video Generation (Img2Vid)</h2>
        <button id="close-video-btn" title="Close Video Panel" class="text-slate-500 hover:text-red-600 p-1.5 rounded-md hover:bg-slate-200 transition duration-150 ease-in-out">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /> </svg>
        </button>
      </div>
      {# Content #}
      <form id="video-gen-form" action="{{ url_for('views.generate_video') }}" method="POST" class="p-4 sm:p-6 flex-shrink-0">
           {# Hidden fields #}
           <input type="hidden" name="conversation_id" value="{{ active_conversation_id | default('', true) }}">
           <input type="hidden" name="topic" value="{{ last_topic | default('', true) }}">
           <input type="hidden" name="image_prompt" value="{{ last_image_prompt | default('', true) }}">
           <input type="hidden" name="last_refined_prompt" value="{{ last_refined_prompt | default('', true) }}">
           <input type="hidden" name="generated_image_base64" value="{{ generated_image_base64 | default('', true) }}">
           <input type="hidden" name="audio_text" value="{{ last_audio_text | default('', true) }}">
           <input type="hidden" name="language_code" value="{{ last_language_code | default('en', true) }}">
           <input type="hidden" name="speaker_id" value="{{ last_speaker_id | default('', true) }}">
           <input type="hidden" name="generated_audio_base64" value="{{ generated_audio_base64 | default('', true) }}">
           {# === Hidden input specifically for this form to carry the image state === #}
           <input type="hidden" id="video_form_init_image_base64" name="last_init_image_base64" value="{{ last_init_image_base64 | default('', true) }}">

           {# --- Display Input Image (Reads from shared state)--- #}
           <div class="mb-4 border border-slate-200 rounded-lg p-3 bg-slate-50">
                <label class="block text-slate-700 text-sm font-semibold mb-2">Input Image for Video</label>
                <div id="video-input-image-preview-container" class="mt-2 {% if not last_init_image_base64 %}hidden{% endif %}">
                    <div class="relative group w-32 h-32 border border-slate-300 rounded overflow-hidden bg-white flex items-center justify-center">
                        <img id="video-input-image-preview" src="{{ 'data:image/png;base64,' ~ last_init_image_base64 if last_init_image_base64 else '#' }}" alt="Input image for video" class="w-full h-full object-contain">
                    </div>
                 </div>
                 <p id="video-input-image-placeholder" class="text-xs text-red-600 font-medium mt-1 {% if last_init_image_base64 %}hidden{% endif %}"> Required: Upload or generate an image first. </p>
                 <p class="text-xs text-slate-500 mt-1 {% if not last_init_image_base64 %}hidden{% endif %}"> Image from Visual panel is used. </p>
            </div>

           {# Video Prompt Input - REMOVED 'required' attribute as it's optional for the SVD workflow #}
           <div class="mb-4">
                <label for="video_prompt" class="block text-slate-700 text-sm font-semibold mb-2"> Video Motion Description (Optional): </label>
                <textarea id="video_prompt" name="video_prompt" rows="3" class="shadow-sm appearance-none border border-slate-300 rounded-lg w-full py-2 px-3 text-gray-700 text-sm leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-y" placeholder="Describe desired animation or motion...">{{ last_video_prompt | default('', true) }}</textarea>
                <p class="text-xs text-slate-500 mt-1">Describe how the image should animate (optional for this workflow).</p>
           </div>

           {# Submit Button - Enabled based on image presence #}
           <button type="submit" id="video-submit-button" class="w-full flex items-center justify-center text-white font-semibold py-2.5 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out shadow-sm text-sm {% if not active_conversation_id or not last_init_image_base64 %} bg-gray-400 cursor-not-allowed {% else %} bg-blue-600 hover:bg-blue-700 {% endif %}" {% if not active_conversation_id or not last_init_image_base64 %} disabled {% endif %} title="{% if not active_conversation_id %}Select chat first.{% elif not last_init_image_base64 %}Input image required.{% else %}Generate Video{% endif %}">
    <span class="button-text">Generate Video (GIF)</span>
    <span id="video-loading-indicator" class="loading-spinner hidden ml-2"><div class="spinner spinner-blue"></div></span>
</button>
      </form>
      {# Video Status/Result Display Area #}
      <div class="mt-4 p-4 sm:p-6 text-center flex flex-col border-t border-slate-200 min-h-[150px] flex-grow">
           {# Display Status Message #}
           {% if video_status_message %}
                {% set message_type = 'success' if 'submitted' in video_status_message|lower else ('warning' if 'error' not in video_status_message|lower else 'error') %}
                <div class="mb-4 p-3 rounded-md text-sm border
                            {% if message_type == 'success' %} bg-green-50 text-green-800 border-green-300
                            {% elif message_type == 'warning' %} bg-yellow-50 text-yellow-800 border-yellow-300
                            {% else %} bg-red-50 text-red-800 border-red-300 {% endif %}" role="alert">
                    <strong class="font-semibold">Status:</strong>
                    <span class="block mt-1 whitespace-pre-wrap">{{ video_status_message }}</span>
                </div>
                 {# Hint for manual check #}
                 <p class="text-xs text-slate-500 mt-3">Check the <code class="text-xs bg-slate-200 px-1 py-0.5 rounded">./output</code> folder on your host machine for the generated GIF after processing completes.</p>
           {% else %}
                 <div class="flex-grow flex items-center justify-center text-slate-500 italic text-sm">Video generation status will appear here.<br>(Requires an input image from the Visual panel)</div>
           {% endif %}
      </div>
  </aside>
  <!-- **** End Right Video Panel **** -->


  <!-- **** Main Chat Area **** -->
  <main id="main-chat-area" class="flex-1 flex flex-col h-full bg-slate-50 transition-[margin] duration-300 ease-in-out">
      <!-- Chat Header -->
      <header class="p-4 sm:p-6 border-b border-slate-200 flex-shrink-0 bg-white flex items-center justify-between space-x-4 sticky top-0 z-10 shadow-sm">
          {# Left Toggle #}
          <button id="toggle-businesses-btn" title="Toggle Businesses" class="flex-shrink-0 text-slate-500 hover:text-primary p-1.5 rounded-md hover:bg-slate-100 transition duration-150 ease-in-out">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" /> </svg>
          </button>
          {# Chat Title #}
          <h1 class="flex-grow text-xl sm:text-2xl font-semibold text-slate-800 truncate text-center">
              {% set display_title = 'New Business Chat' %} {# Default title #}
              {% if active_conversation_id and all_conversations %}
                  {% for convo in all_conversations %}
                      {% if convo._id|string == active_conversation_id|string %}
                          {% set display_title = convo.title | default('Untitled Chat', true) %}
                      {% endif %}
                  {% endfor %}
              {% endif %}
              {{ display_title }}
          </h1>
          {# Right Toggles #}
          <div class="flex items-center space-x-2 flex-shrink-0">
              <button id="toggle-image-btn" title="Toggle Image Generation" class="text-slate-500 hover:text-purple-600 p-1.5 rounded-md hover:bg-slate-100 transition duration-150 ease-in-out">
                   <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /> </svg>
              </button>
              <button id="toggle-audio-btn" title="Toggle Audio Generation" class="text-slate-500 hover:text-teal-600 p-1.5 rounded-md hover:bg-slate-100 transition duration-150 ease-in-out">
                   <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /> </svg>
              </button>
              <button id="toggle-video-btn" title="Toggle Video Generation" class="text-slate-500 hover:text-blue-600 p-1.5 rounded-md hover:bg-slate-100 transition duration-150 ease-in-out">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /> </svg>
              </button>
          </div>
      </header>

       <!-- Flash Messages -->
       {% with messages = get_flashed_messages(with_categories=true) %}
           {% if messages %}
           <div class="flex-shrink-0 p-4 space-y-2 border-b border-slate-200 bg-white">
               {% for category, message in messages %}
                <div class="p-4 rounded-lg text-sm shadow-md border {{ 'bg-red-50 text-red-800 border-red-300' if category == 'error' else 'bg-green-50 text-green-800 border-green-300' if category == 'success' else 'bg-blue-50 text-blue-800 border-blue-300' }}">
                    {{ message }}
                </div>
               {% endfor %}
           </div>
           {% endif %}
       {% endwith %}

      <!-- Chat History Display -->
      <div id="chat-history" class="flex-grow overflow-y-auto min-h-0 p-4 sm:p-6 scrollbar-thin scrollbar-thumb-slate-400 scrollbar-track-slate-200">
            {# Welcome/Empty State or Chat Messages #}
            {% if not active_conversation_id %}
             <div class="h-full flex flex-col justify-center items-center text-center">
                 <div class="max-w-lg w-full bg-white rounded-xl shadow-sm border border-slate-200 p-6 sm:p-8">
                    <svg class="w-16 h-16 mx-auto text-primary mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
                    <h2 class="text-2xl font-semibold text-slate-800 mb-2">Welcome to MarketMind!</h2>
                    <p class="text-slate-600 mb-6">Your AI marketing assistant for small businesses.</p>
                    <p class="text-slate-500 mb-4 text-sm">Describe your business or ask a marketing question below to start your first chat!</p>
                 </div>
             </div>
            {% elif chat_history %}
                 {# Message loop #}
                 {% for message in chat_history %}
                    {% if message.role == 'user' %}
                    <div class="flex justify-end group mb-4">
                        <div class="bg-primary text-white rounded-xl rounded-br-lg py-2 px-4 max-w-lg lg:max-w-xl xl:max-w-2xl shadow-sm relative break-words">
                            <p class="text-sm whitespace-pre-wrap">{{ message.content }}</p>
                        </div>
                    </div>
                    {% elif message.role == 'assistant' %}
                    <div class="flex justify-start group mb-4">
                        <div class="bg-white text-slate-800 rounded-xl rounded-bl-lg py-2 px-4 max-w-lg lg:max-w-xl xl:max-w-2xl shadow-sm border border-slate-200 relative break-words">
                            <p class="text-sm whitespace-pre-wrap">{{ message.content }}</p>
                            {# Hover Buttons #}
                            <div class="absolute -bottom-2 right-2 flex items-center space-x-1 opacity-0 group-hover:opacity-100 transition-opacity duration-150">
                                <button data-prompt="{{ message.content }}" onclick="copyPromptToImage(this)" title="Use for Image Prompt" class="bg-slate-200 hover:bg-purple-200 text-slate-600 hover:text-purple-700 p-1 rounded-full shadow-md text-xs">
                                    <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /> </svg>
                                </button>
                                <button data-prompt="{{ message.content }}" onclick="copyPromptToVideo(this)" title="Use for Video Prompt" class="bg-slate-200 hover:bg-blue-200 text-slate-600 hover:text-blue-700 p-1 rounded-full shadow-md text-xs">
                                    <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /> </svg>
                                </button>
                                <button data-audio-text="{{ message.content }}" onclick="copyTextToAudio(this)" title="Use for Audio Generation" class="bg-slate-200 hover:bg-teal-200 text-slate-600 hover:text-teal-700 p-1 rounded-full shadow-md text-xs">
                                    <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /> </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                 {% endfor %}
            {% else %}
                 {# Empty chat state #}
                 <div class="h-full flex items-center justify-center">
                     <p class="text-slate-500 italic text-sm text-center">No messages in this chat yet.<br>Send your first message below!</p>
                 </div>
            {% endif %}
            {# Anchor for scrolling #}
            <div id="scroll-anchor"></div>
      </div>

      <!-- Chat Input Form -->
      <div class="flex-shrink-0 p-4 sm:p-6 border-t border-slate-200 bg-white shadow-inner">
          <form id="text-prompt-form" action="{{ url_for('views.generate_text_prompt') }}" method="POST" class="flex items-center space-x-3">
              {# Hidden fields for ALL state #}
              <input type="hidden" name="conversation_id" value="{{ active_conversation_id | default('', true) }}">
              <input type="hidden" name="image_prompt" value="{{ last_image_prompt | default('', true) }}">
              <input type="hidden" name="last_refined_prompt" value="{{ last_refined_prompt | default('', true) }}">
              <input type="hidden" name="generated_image_base64" value="{{ generated_image_base64 | default('', true) }}">
              <input type="hidden" id="text_form_init_image_base64" name="last_init_image_base64" value="{{ last_init_image_base64 | default('', true) }}"> {# Carries shared image state for the form #}
              <input type="hidden" name="audio_text" value="{{ last_audio_text | default('', true) }}">
              <input type="hidden" name="language_code" value="{{ last_language_code | default('en', true) }}">
              <input type="hidden" name="speaker_id" value="{{ last_speaker_id | default('', true) }}">
              <input type="hidden" name="generated_audio_base64" value="{{ generated_audio_base64 | default('', true) }}">
              <input type="hidden" name="video_prompt" value="{{ last_video_prompt | default('', true) }}">
              <input type="hidden" name="video_status_message" value="{{ video_status_message | default('', true) }}">

              {# Text Input Area #}
              <label for="topic" class="sr-only">Your Message:</label>
              <textarea id="topic" name="topic" rows="1" required class="flex-grow shadow-sm appearance-none border border-slate-300 rounded-lg py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent resize-none text-sm" placeholder="Ask for marketing ideas, content suggestions...">{{ last_topic | default('', true) }}</textarea>
              {# Submit Button #}
              <button type="submit" id="text-submit-button" title="Send Message" class="flex-shrink-0 flex items-center justify-center bg-primary hover:bg-primary-dark text-white font-semibold p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out shadow-sm">
    <span class="button-text">
        <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"> <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /> </svg>
    </span>
    {# The loading indicator div for THIS button #}
    <span id="text-loading-indicator" class="loading-spinner hidden"><div class="spinner spinner-small"></div></span>
</button>
          </form>
           <p class="text-xs text-slate-500 mt-2 text-center">MarketMind can help brainstorm ideas. Always review suggestions.</p>
      </div>

  </main>
  <!-- **** End Main Chat Area **** -->

</div>
{# End dashboard container #}
{% endblock %} {# End content block override #}


{% block scripts %}
<script>
 // --- Helper Functions ---
 function copyPromptToImage(buttonElement) {
    const promptText = buttonElement.getAttribute('data-prompt');
    const imagePromptTextarea = document.getElementById('image_prompt');
    if (imagePromptTextarea) {
        imagePromptTextarea.value = promptText;
        imagePromptTextarea.focus();
        imagePromptTextarea.dispatchEvent(new Event('input', { bubbles: true }));
        autoResizeTextarea(imagePromptTextarea);
        if (!isPanelOpen('image')) { togglePanel('image', true); }
    }
 }

 function copyTextToAudio(buttonElement) {
    const audioText = buttonElement.getAttribute('data-audio-text');
    const audioTextTextarea = document.getElementById('audio_text');
    if (audioTextTextarea) {
        audioTextTextarea.value = audioText;
        audioTextTextarea.focus();
        audioTextTextarea.dispatchEvent(new Event('input', { bubbles: true }));
        autoResizeTextarea(audioTextTextarea);
        if (!isPanelOpen('audio')) { togglePanel('audio', true); }
    }
 }

 function copyPromptToVideo(buttonElement) {
    const promptText = buttonElement.getAttribute('data-prompt');
    const videoPromptTextarea = document.getElementById('video_prompt');
    if (videoPromptTextarea) {
        videoPromptTextarea.value = promptText;
        videoPromptTextarea.focus();
        videoPromptTextarea.dispatchEvent(new Event('input', { bubbles: true }));
        autoResizeTextarea(videoPromptTextarea);
        // Also, ensure the image used for this video prompt is set if logic allows
        // For now, just opens the panel
        if (!isPanelOpen('video')) { togglePanel('video', true); }
    }
 }

 function scrollToBottom(elementId) {
     const element = document.getElementById(elementId);
     if (element && element.scrollHeight > element.clientHeight) {
        element.scrollTo({ top: element.scrollHeight, behavior: 'smooth' });
     }
 }

 function autoResizeTextarea(textarea) {
    if (!textarea) return;
    textarea.style.height = 'auto';
    const maxHeight = 160; // Adjust as needed
    const scrollHeight = textarea.scrollHeight;
    textarea.style.height = Math.min(scrollHeight, maxHeight) + 2 + 'px';
    textarea.style.overflowY = scrollHeight > maxHeight ? 'auto' : 'hidden';
 }

 // --- Trigger video generation using the shared image state ---
 function triggerVideoFromImage(imageBase64) {
    const sharedHiddenImageInput = document.getElementById('shared_init_image_base64');
    // Update Video Panel form's hidden input
    const videoFormImageInput = document.getElementById('video_form_init_image_base64');
    if (videoFormImageInput) videoFormImageInput.value = imageBase64;

    // Update UI (previews, button state)
    updateSharedImageState(imageBase64); // This will update both image and video panel previews and buttons

    // Open video panel if closed and focus
    if (!isPanelOpen('video')) { togglePanel('video', true); }
    const videoPromptTextarea = document.getElementById('video_prompt');
    if (videoPromptTextarea) videoPromptTextarea.focus();
 }


 // **** Panel Toggle Logic ****
 document.addEventListener('DOMContentLoaded', () => {
    // --- Element References ---
    const panels = { businesses: document.getElementById('businesses-sidebar'), image: document.getElementById('image-panel'), audio: document.getElementById('audio-panel'), video: document.getElementById('video-panel') };
    const toggleButtons = { businesses: document.getElementById('toggle-businesses-btn'), image: document.getElementById('toggle-image-btn'), audio: document.getElementById('toggle-audio-btn'), video: document.getElementById('toggle-video-btn') };
    const closeButtons = { businesses: document.getElementById('close-businesses-btn'), image: document.getElementById('close-image-btn'), audio: document.getElementById('close-audio-btn'), video: document.getElementById('close-video-btn') };
    const mainChatArea = document.getElementById('main-chat-area');
    const chatHistory = document.getElementById('chat-history');
    const dashboardContainer = mainChatArea ? mainChatArea.parentElement : null;

    // --- State Check ---
    window.isPanelOpen = function(panelId) { const p = panels[panelId]; return p && ((panelId === 'businesses') ? !p.classList.contains('-translate-x-full') : !p.classList.contains('translate-x-full')); };

    // --- Margin Adjustment ---
    function adjustMainContentMargins() { if (!mainChatArea) return; const l = isPanelOpen('businesses'); const r = ['image', 'audio', 'video'].some(isPanelOpen); mainChatArea.style.marginLeft = l ? '18rem' : '0px'; mainChatArea.style.marginRight = r ? '24rem' : '0px'; };

    // --- Toggle Panel Function ---
    window.togglePanel = function(panelId, forceOpen) {
        const panel = panels[panelId]; if (!panel) return;
        const current = isPanelOpen(panelId); let shouldOpen = (forceOpen === undefined) ? !current : !!forceOpen; if (shouldOpen === current) return;
        const rightPanelIds = ['image', 'audio', 'video'];
        if (shouldOpen && rightPanelIds.includes(panelId)) { rightPanelIds.forEach(id => { if (id !== panelId && isPanelOpen(id)) { const otherPanel = panels[id]; if (otherPanel) otherPanel.classList.add('translate-x-full'); } }); }
        panel.classList.toggle(panelId === 'businesses' ? '-translate-x-full' : 'translate-x-full', !shouldOpen);
        if (rightPanelIds.includes(panelId)) { const z = '20', zc = '10'; rightPanelIds.forEach(id => { if (panels[id]) panels[id].style.zIndex = (id === panelId && shouldOpen) ? z : zc; }); }
        requestAnimationFrame(adjustMainContentMargins);
    };

    // --- Event Listeners ---
    Object.keys(toggleButtons).forEach(key => { if (toggleButtons[key]) toggleButtons[key].addEventListener('click', (e) => { e.stopPropagation(); togglePanel(key); }); });
    Object.keys(closeButtons).forEach(key => { if (closeButtons[key]) closeButtons[key].addEventListener('click', (e) => { e.stopPropagation(); togglePanel(key, false); }); });

    // --- Click Outside Handler ---
    if (dashboardContainer) {
         dashboardContainer.addEventListener('click', (e) => {
             const clickedInsideAPanel = Object.values(panels).some(p => p && p.contains(e.target));
             const clickedInsideMainInteractive = mainChatArea && mainChatArea.contains(e.target) && e.target.closest('button, a, input, textarea, select, [role="button"], [onclick]');
             const clickedOnAnyToggleButton = Object.values(toggleButtons).some(b => b && b.contains(e.target));
             if (!clickedInsideAPanel && !clickedInsideMainInteractive && !clickedOnAnyToggleButton) { Object.keys(panels).forEach(key => { if (isPanelOpen(key)) togglePanel(key, false); }); }
         });
     }

    // --- Initial Setup ---
    adjustMainContentMargins();
    if (chatHistory) { const initialScroll = () => { if (chatHistory.scrollHeight > chatHistory.clientHeight) { chatHistory.scrollTop = chatHistory.scrollHeight; } }; setTimeout(initialScroll, 50); const observer = new MutationObserver((mutations) => { let addedNodes = mutations.some(m => m.type === 'childList' && m.addedNodes.length > 0); if(addedNodes) { const isScrolledNearBottom = chatHistory.scrollHeight - chatHistory.clientHeight <= chatHistory.scrollTop + 150; if (isScrolledNearBottom) { scrollToBottom('chat-history'); } } }); observer.observe(chatHistory, { childList: true }); }
    document.querySelectorAll('textarea').forEach(textarea => { textarea.addEventListener('input', () => autoResizeTextarea(textarea)); textarea.addEventListener('focus', () => autoResizeTextarea(textarea)); textarea.addEventListener('blur', () => autoResizeTextarea(textarea)); autoResizeTextarea(textarea); });

    // --- Shared Image State Handling (using a SHARED hidden input and form-specific inputs) ---
    const imageUploadInput = document.getElementById('init_image_upload');
    const imagePreviewContainer = document.getElementById('init-image-preview-container');
    const imagePreview = document.getElementById('init-image-preview');
    const sharedHiddenImageInput = document.getElementById('shared_init_image_base64');
    const clearImageButton = document.getElementById('clear-init-image');
    const videoInputPreviewContainer = document.getElementById('video-input-image-preview-container');
    const videoInputPreview = document.getElementById('video-input-image-preview');
    const videoInputPlaceholder = document.getElementById('video-input-image-placeholder');
    const videoGenerateButton = document.getElementById('video-submit-button');
    // Hidden inputs within each form that needs the shared image state
    const imageFormImageInput = document.getElementById('image_form_init_image_base64');
    const audioFormImageInput = document.getElementById('audio_form_init_image_base64');
    const videoFormImageInput = document.getElementById('video_form_init_image_base64');
    const textFormImageInput = document.getElementById('text_form_init_image_base64');

    // --- Function to update the shared hidden input AND all form-specific hidden inputs, and UI elements ---
    window.updateSharedImageState = function(base64) { // Make it global for triggerVideoFromImage
        const safeBase64 = base64 || '';
        // Update the primary shared state input
        if (sharedHiddenImageInput) sharedHiddenImageInput.value = safeBase64;
        // Update hidden inputs within each form
        if (imageFormImageInput) imageFormImageInput.value = safeBase64;
        if (audioFormImageInput) audioFormImageInput.value = safeBase64;
        if (videoFormImageInput) videoFormImageInput.value = safeBase64;
        if (textFormImageInput) textFormImageInput.value = safeBase64;

        // Update UI elements based on whether an image is present
        const hasImage = !!safeBase64;
        const dataUrl = hasImage ? `data:image/png;base64,${safeBase64}` : '#';

        // Update Image Panel Preview
        if (imagePreview) { imagePreview.src = dataUrl; imagePreview.classList.toggle('hidden', !hasImage); }
        if (imagePreviewContainer) imagePreviewContainer.classList.toggle('hidden', !hasImage);
        // Update Video Panel Preview
        if (videoInputPreview) { videoInputPreview.src = dataUrl; } // videoInputPreview.classList.toggle('hidden', !hasImage); (container handles visibility)
        if (videoInputPreviewContainer) videoInputPreviewContainer.classList.toggle('hidden', !hasImage);
        if (videoInputPlaceholder) videoInputPlaceholder.classList.toggle('hidden', hasImage);
        // Update Video Button State
        if (videoGenerateButton) {
            const isActiveConvo = document.querySelector('input[name="conversation_id"]')?.value; // Simple check if convo ID is set
            const canGenerateVideo = hasImage && isActiveConvo;
            videoGenerateButton.disabled = !canGenerateVideo;
            videoGenerateButton.classList.toggle('bg-gray-400', !canGenerateVideo);
            videoGenerateButton.classList.toggle('cursor-not-allowed', !canGenerateVideo);
            videoGenerateButton.classList.toggle('bg-blue-600', canGenerateVideo);
            videoGenerateButton.classList.toggle('hover:bg-blue-700', canGenerateVideo);
            if (!isActiveConvo) videoGenerateButton.title = "Select chat first.";
            else if (!hasImage) videoGenerateButton.title = "Input image required.";
            else videoGenerateButton.title = "Generate Video";
        }
    }
    window.clearImageSelection = function() { // Make it global
        if (imageUploadInput) imageUploadInput.value = null;
        updateSharedImageState(''); // Pass empty string to clear
    }

    // --- Image Input Listener (from Image Panel Upload) ---
    if (imageUploadInput && sharedHiddenImageInput) {
        imageUploadInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64String = e.target.result.split(',')[1];
                    updateSharedImageState(base64String);
                }
                reader.onerror = function() { clearImageSelection(); }
                reader.readAsDataURL(file);
            } else {
                if(imageUploadInput.value) alert("Invalid file type. Please upload PNG, JPEG, or WEBP.");
                clearImageSelection();
            }
        });
    }
    // --- Clear Image Button Listener ---
    if (clearImageButton) { clearImageButton.addEventListener('click', (e) => { e.stopPropagation(); clearImageSelection(); }); }
    // --- Initial Image State Check on Load ---
    const initialBase64 = sharedHiddenImageInput?.value;
    updateSharedImageState(initialBase64); // This will set up all previews and form inputs correctly
    // --- End Shared Image State Handling ---


    // **** Form Submission Loading Logic ****
    const forms = [
        { formId: 'text-prompt-form', submitId: 'text-submit-button', indicatorId: 'text-loading-indicator' },
        { formId: 'image-gen-form', submitId: 'image-submit-button', indicatorId: 'image-loading-indicator' },
        { formId: 'audio-gen-form', submitId: 'audio-submit-button', indicatorId: 'audio-loading-indicator' },
        { formId: 'video-gen-form', submitId: 'video-submit-button', indicatorId: 'video-loading-indicator' }
    ];

    function handleFormSubmission(event, submitButton, loadingIndicator, buttonTextElement) {
        if (submitButton && !submitButton.disabled) {
            if (submitButton) {
                submitButton.disabled = true;
                if(buttonTextElement) buttonTextElement.classList.add('hidden'); // Hide original text
            }
            if (loadingIndicator) {
                loadingIndicator.classList.remove('hidden'); // Show spinner
                if(loadingIndicator.parentElement === submitButton) loadingIndicator.classList.add('inline-flex'); // If spinner is inside button
            }
        } else if (submitButton && submitButton.disabled) {
             event.preventDefault(); // Prevent re-submission if already processing
        }
        // Allow default form submission if not handled above
    }

    forms.forEach(f => {
        const form = document.getElementById(f.formId);
        const submitButton = document.getElementById(f.submitId);
        const loadingIndicator = document.getElementById(f.indicatorId);
        const buttonTextElement = submitButton ? submitButton.querySelector('.button-text') : null;

        if (form && submitButton && loadingIndicator) {
            form.addEventListener('submit', (e) => handleFormSubmission(e, submitButton, loadingIndicator, buttonTextElement));
        } else {
            console.warn(`Form submission elements not found for form ID: ${f.formId}`);
        }
    });

    // Make text input button also show spinner inside
    const textSubmitButton = document.getElementById('text-submit-button');
    if (textSubmitButton) {
        const textButtonText = textSubmitButton.querySelector('.button-text');
        const textLoadingSpinner = textSubmitButton.querySelector('.loading-spinner');
        textSubmitButton.form.addEventListener('submit', (e) => {
            if (!textSubmitButton.disabled) {
                if (textButtonText) textButtonText.classList.add('hidden');
                if (textLoadingSpinner) textLoadingSpinner.classList.remove('hidden');
            }
        });
    }

 });
</script>
{% endblock %} {# End scripts block #}