{% extends "base.html" %} {# Assumes base.html has Tailwind linked #}

{% block title %}Dashboard - MarketMind AI{% endblock %}

{% block content %}
<div class="flex h-[calc(100vh-4rem)] bg-white"> {# Main flex container #}

  <!-- Sidebar -->
  <aside class="w-72 flex-shrink-0 bg-slate-50 border-r border-slate-200 flex flex-col">
    <div class="p-4 border-b border-slate-200 flex-shrink-0"> <h2 class="text-lg font-semibold text-slate-700">My Businesses</h2> </div>
    <div class="p-4 flex-shrink-0"> <a href="{{ url_for('views.dashboard') }}" class="flex items-center justify-center w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2.5 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 text-sm transition duration-150 ease-in-out shadow-sm"> <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /> </svg> New Business Chat </a> </div>
    <nav class="flex-grow overflow-y-auto p-4 space-y-1 scrollbar-thin scrollbar-thumb-slate-300 scrollbar-track-slate-100">
      {% if all_conversations %} {% for convo in all_conversations %} <a href="{{ url_for('views.dashboard', conversation_id=convo._id) }}" class="block px-3 py-2 rounded-md text-sm font-medium truncate transition duration-150 ease-in-out {% if active_conversation_id and convo._id|string == active_conversation_id %} bg-indigo-100 text-indigo-800 hover:bg-indigo-200 {% else %} text-slate-600 hover:bg-slate-200 hover:text-slate-800 {% endif %}"> {{ convo.title | default('Untitled Business', true) }} </a> {% endfor %} {% else %} <p class="text-slate-500 italic text-sm px-3 py-2">Start your first business chat!</p> {% endif %}
    </nav>
  </aside>
  <!-- End Sidebar -->

  <!-- Main Content Area -->
  <main class="flex-1 flex overflow-y-hidden">
    <!-- Chat Panel -->
    <section class="flex-1 flex flex-col overflow-y-hidden bg-slate-50 border-r border-slate-200">
      <header class="p-4 sm:p-6 border-b border-slate-200 flex-shrink-0 bg-white"> <h1 class="text-xl sm:text-2xl font-semibold text-slate-800 truncate"> {% if active_conversation_id and chat_history %} {{ chat_history[0].content[:50] + ('...' if chat_history[0].content|length > 50 else '') }} {% elif active_conversation_id %} Selected Business Chat {% else %} Welcome, {{ user.first_name }}! Let's Grow Your Business. {% endif %} </h1> </header>
      {% with messages = get_flashed_messages(with_categories=true) %} {% if messages %} <div class="flex-shrink-0 p-4 space-y-2 border-b border-slate-200"> {% for category, message in messages %} <div class="p-3 rounded-md text-sm shadow-sm border {% if category == 'error' %} bg-red-50 border-red-300 text-red-800 {% elif category == 'success' %} bg-green-50 border-green-300 text-green-800 {% else %} bg-blue-50 border-blue-300 text-blue-800 {% endif %}" role="alert"> {{ message }} </div> {% endfor %} </div> {% endif %} {% endwith %}
      <!-- Chat History Display -->
      <div id="chat-history" class="flex-grow space-y-4 p-4 sm:p-6 overflow-y-auto scrollbar-thin scrollbar-thumb-slate-400 scrollbar-track-slate-200">
            {% if not active_conversation_id %} <div class="flex items-center justify-center h-full"> <p class="text-slate-500 text-center text-base">Select a business chat from the left sidebar or start a new one below.</p> </div>
            {% elif chat_history %}
                {% for message in chat_history %}
                    {% if message.role == 'user' %} <div class="flex justify-end group"> <div class="bg-indigo-600 text-white rounded-xl rounded-br-lg py-2 px-4 max-w-lg lg:max-w-xl shadow-sm relative"> <p class="text-sm whitespace-pre-wrap">{{ message.content }}</p> </div> </div>
                    {% elif message.role == 'assistant' %} <div class="flex justify-start group"> <div class="bg-white text-slate-800 rounded-xl rounded-bl-lg py-2 px-4 max-w-lg lg:max-w-xl shadow-sm border border-slate-200 relative"> <p class="text-sm whitespace-pre-wrap">{{ message.content }}</p> <div class="mt-2 flex justify-end space-x-2 border-t border-gray-200 pt-1"> <button data-prompt="{{ message.content }}" onclick="copyPromptToImage(this)" title="Use for Image Prompt" class="bg-slate-200 hover:bg-slate-300 text-slate-600 font-bold p-1.5 rounded-full shadow text-xs transition-opacity duration-150 opacity-70 group-hover:opacity-100"> <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /> </svg> </button> <button data-audio-text="{{ message.content }}" onclick="copyTextToAudio(this)" title="Use for Audio Generation" class="bg-slate-200 hover:bg-slate-300 text-slate-600 font-bold p-1.5 rounded-full shadow text-xs transition-opacity duration-150 opacity-70 group-hover:opacity-100"> <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /> </svg> </button> </div> </div> </div>
                    {% endif %}
                {% endfor %}
            {% else %} <div class="flex items-center justify-center h-full"> <p class="text-slate-500 italic text-sm text-center">No messages yet. Send one below!</p> </div>
            {% endif %}
      </div>
      <!-- Chat Input Form -->
      <div class="flex-shrink-0 p-4 sm:p-6 border-t border-slate-200 bg-white">
          <form action="{{ url_for('views.generate_text_prompt') }}" method="POST" class="flex items-center space-x-3">
              {# Pass state back and forth between forms #}
              <input type="hidden" name="conversation_id" value="{{ active_conversation_id | default('', true) }}">
              <input type="hidden" name="image_prompt" value="{{ last_image_prompt | default('', true) }}">
              <input type="hidden" name="audio_text" value="{{ last_audio_text | default('', true) }}">
              <input type="hidden" name="language_code" value="{{ last_language_code | default('en', true) }}">
              <input type="hidden" name="speaker_id" value="{{ last_speaker_id | default('', true) }}">

              <label for="topic" class="sr-only">Your Message:</label>
              <textarea id="topic" name="topic" rows="1" required class="flex-grow shadow-sm appearance-none border border-slate-300 rounded-lg py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none text-sm" placeholder="Ask for marketing ideas, content suggestions...">{{ last_topic | default('', true) }}</textarea>
              <button type="submit" title="Send Message" class="flex-shrink-0 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out shadow-sm"> <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"> <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /> </svg> </button>
          </form>
           <p class="text-xs text-slate-500 mt-2 text-center">MarketMind can help brainstorm ideas. Always review suggestions.</p>
      </div>
    </section>
    <!-- End Chat Panel -->

    <!-- Side Panels (Image & Audio) -->
    <aside class="w-96 flex-shrink-0 bg-white border-l border-slate-200 overflow-y-auto flex flex-col scrollbar-thin scrollbar-thumb-slate-300 scrollbar-track-slate-100">
      <!-- Image Generation Panel -->
      <div class="p-4 sm:p-6 border-b border-slate-200 flex-shrink-0"> <h2 class="text-lg font-semibold text-slate-700">Visual Generation</h2> </div>
      <form action="{{ url_for('views.generate_image') }}" method="POST" class="p-4 sm:p-6 flex-shrink-0">
          {# Pass relevant state back #}
          <input type="hidden" name="conversation_id" value="{{ active_conversation_id | default('', true) }}">
          <input type="hidden" name="topic" value="{{ last_topic | default('', true) }}">
          <input type="hidden" name="audio_text" value="{{ last_audio_text | default('', true) }}">
          <input type="hidden" name="language_code" value="{{ last_language_code | default('en', true) }}">
          <input type="hidden" name="speaker_id" value="{{ last_speaker_id | default('', true) }}">
          <input type="hidden" name="generated_audio_base64" value="{{ generated_audio_base64 | default('', true) }}">

          <div class="mb-4"> <label for="image_prompt" class="block text-slate-700 text-sm font-semibold mb-2"> Image Prompt </label> <textarea id="image_prompt" name="image_prompt" rows="4" required class="shadow-sm appearance-none border border-slate-300 rounded-lg w-full py-2 px-3 text-gray-700 text-sm leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-y" placeholder="Describe the visual you want...">{{ last_image_prompt | default('', true) }}</textarea> <p class="text-xs text-slate-500 mt-1">Use text from chat or write your own description.</p> </div>
          <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2.5 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition duration-150 ease-in-out shadow-sm text-sm" {% if not active_conversation_id %} disabled title="Please select or start a business chat first." class="w-full bg-gray-400 text-white font-semibold py-2.5 px-4 rounded-lg cursor-not-allowed shadow-sm text-sm" {% endif %}> Generate Image </button>
      </form>
      <!-- Image Result Display -->
      <div class="mt-4 p-4 sm:p-6 text-center flex flex-col border-t border-slate-200 min-h-[200px]">
          {% if generated_image_base64 %} <h3 class="text-base font-semibold text-slate-700 mb-3 flex-shrink-0">Generated Visual:</h3> <div class="flex-shrink-0 mb-4 bg-slate-100 p-2 rounded-lg border border-slate-200"> <img src="data:image/png;base64,{{ generated_image_base64 }}" alt="Generated Image" class="max-w-full h-auto mx-auto rounded shadow"> </div> <div class="text-xs text-slate-600 text-left bg-slate-100 p-3 rounded-md border border-slate-200 space-y-1 flex-shrink-0"> <p><strong>Original Input:</strong><br> <code class="block bg-white p-1 rounded border text-slate-800 break-words">{{ last_image_prompt }}</code> </p> {% if last_refined_prompt and last_refined_prompt != last_image_prompt %} <p class="border-t border-slate-200 pt-1"><strong>Prompt Used:</strong><br> <code class="block bg-white p-1 rounded border text-slate-800 break-words">{{ last_refined_prompt }}</code> </p> {% endif %} </div>
          {% elif image_error %} <div class="flex-grow flex items-center justify-center text-slate-500 italic text-sm">Image generation failed.</div>
          {% else %} <div class="flex-grow flex items-center justify-center text-slate-500 italic text-sm">Image will appear here.</div>
          {% endif %}
          {% if image_error %} <div class="mt-4 p-3 bg-red-50 border border-red-300 text-red-800 rounded-md text-sm flex-shrink-0" role="alert"> <strong class="font-semibold">Image Generation Error:</strong> <span class="block mt-1">{{ image_error }}</span> </div> {% endif %}
      </div>

      <!-- Audio Generation Panel -->
      <div class="p-4 sm:p-6 border-t border-slate-200 flex-shrink-0 mt-6"> <h2 class="text-lg font-semibold text-slate-700 mb-4">Audio Generation (TTS)</h2> </div>
      <form action="{{ url_for('views.generate_audio') }}" method="POST" class="p-4 sm:p-6 flex-shrink-0 pt-0">
          {# Pass relevant state back #}
          <input type="hidden" name="conversation_id" value="{{ active_conversation_id | default('', true) }}">
          <input type="hidden" name="topic" value="{{ last_topic | default('', true) }}">
          <input type="hidden" name="image_prompt" value="{{ last_image_prompt | default('', true) }}">
          <input type="hidden" name="last_refined_prompt" value="{{ last_refined_prompt | default('', true) }}">
          <input type="hidden" name="generated_image_base64" value="{{ generated_image_base64 | default('', true) }}">

          {# Language Selection #}
          <div class="mb-4">
              <label for="language_code" class="block text-slate-700 text-sm font-semibold mb-2"> Language: </label>
              <select id="language_code" name="language_code" required class="shadow-sm appearance-none border border-slate-300 rounded-lg w-full py-2 px-3 text-gray-700 text-sm leading-tight focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent bg-white">
                  {% for code, name in supported_languages.items() %} <option value="{{ code }}" {% if code == last_language_code %}selected{% endif %}>{{ name }} ({{ code }})</option> {% endfor %}
              </select>
          </div>

          {# Speaker Selection #}
          <div class="mb-4">
              <label for="speaker_id" class="block text-slate-700 text-sm font-semibold mb-2"> Speaker Voice: </label>
              <select id="speaker_id" name="speaker_id" required class="shadow-sm appearance-none border border-slate-300 rounded-lg w-full py-2 px-3 text-gray-700 text-sm leading-tight focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent bg-white"
                      {% if not available_speakers %}disabled{% endif %}> {# Disable if no speakers #}

                  {% if available_speakers %}
                      {# Populate with speakers found by the backend #}
                      {% for speaker in available_speakers %}
                          <option value="{{ speaker }}" {% if speaker == last_speaker_id %}selected{% endif %}>
                              {# Simple formatting for speaker names (filenames / folder names) #}
                              {{ speaker.replace('_', ' ').title() }}
                          </option>
                      {% endfor %}
                  {% else %}
                      <option value="" disabled selected>No Speakers Loaded</option>
                  {% endif %}
              </select>
              {# <<< UPDATED INSTRUCTION TEXT >>> #}
              {% if available_speakers %}
                 <p class="text-xs text-slate-500 mt-1">Select a voice from your './xtts/actors' folder.</p>
              {% else %}
                 <p class="text-xs text-red-600 mt-1">No speakers found. Add .wav files to './xtts/actors'.</p>
              {% endif %}
          </div>

          {# Text Input #}
          <div class="mb-4">
              <label for="audio_text" class="block text-slate-700 text-sm font-semibold mb-2"> Text to Speak: </label>
              <textarea id="audio_text" name="audio_text" rows="4" required class="shadow-sm appearance-none border border-slate-300 rounded-lg w-full py-2 px-3 text-gray-700 text-sm leading-tight focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent resize-y" placeholder="Enter text for the voiceover...">{{ last_audio_text | default('', true) }}</textarea>
              <p class="text-xs text-slate-500 mt-1">Use text from chat or write your own script.</p>
          </div>
          <button type="submit" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2.5 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition duration-150 ease-in-out shadow-sm text-sm" {% if not active_conversation_id %} disabled title="Please select or start a business chat first." class="w-full bg-gray-400 text-white font-semibold py-2.5 px-4 rounded-lg cursor-not-allowed shadow-sm text-sm" {% endif %}> Generate Audio </button>
      </form>
      <!-- Audio Result Display -->
      <div class="mt-4 p-4 sm:p-6 text-center flex flex-col border-t border-slate-200 min-h-[150px]">
           {% if generated_audio_base64 %}
              <h3 class="text-base font-semibold text-slate-700 mb-3 flex-shrink-0">Generated Audio:</h3>
              <div class="flex-shrink-0 mb-4 space-y-2">
                   <audio controls class="w-full h-10"> <source src="data:audio/wav;base64,{{ generated_audio_base64 }}" type="audio/wav"> Your browser does not support the audio element. </audio>
                   <a href="data:audio/wav;base64,{{ generated_audio_base64 }}" download="generated_audio_{{ active_conversation_id }}_{{ range(1, 10000) | random }}.wav" class="inline-block text-xs bg-slate-200 hover:bg-slate-300 text-slate-700 px-3 py-1.5 rounded-md" title="Download WAV file"> Download Audio File </a>
              </div>
              <div class="text-xs text-slate-600 text-left bg-slate-100 p-3 rounded-md border border-slate-200 space-y-1 flex-shrink-0">
                 <p><strong>Text Used:</strong><br> <code class="block bg-white p-1 rounded border text-slate-800 break-words">{{ last_audio_text }}</code> </p>
                 <p class="border-t border-slate-200 pt-1"><strong>Settings:</strong> Lang: {{ last_language_code }}, Speaker: {{ last_speaker_id.replace('_', ' ').title() }}</p>
             </div>
         {% elif audio_error %} <div class="flex-grow flex items-center justify-center text-slate-500 italic text-sm">Audio generation failed.</div>
         {% else %} <div class="flex-grow flex items-center justify-center text-slate-500 italic text-sm">Generated audio player will appear here.</div>
         {% endif %}
         {% if audio_error %} <div class="mt-4 p-3 bg-red-50 border border-red-300 text-red-800 rounded-md text-sm flex-shrink-0" role="alert"> <strong class="font-semibold">Audio Generation Error:</strong> <span class="block mt-1">{{ audio_error }}</span> </div> {% endif %}
      </div>
      <!-- End Audio Result Display -->
    </aside>
    <!-- End Side Panels -->
  </main>
  <!-- End Main Content Area -->
</div> {# End Root Flex container #}

{# --- JavaScript functions --- #}
<script>
 function copyPromptToImage(buttonElement) { const promptText = buttonElement.getAttribute('data-prompt'); const imagePromptTextarea = document.getElementById('image_prompt'); if (imagePromptTextarea && promptText) { imagePromptTextarea.value = promptText; imagePromptTextarea.scrollTop = 0; imagePromptTextarea.focus(); buttonElement.classList.add('bg-green-700'); setTimeout(() => buttonElement.classList.remove('bg-green-700'), 1000); } else { console.error("Error copying to image prompt."); alert("Could not copy text to image prompt."); } }
 function copyTextToAudio(buttonElement) { const textToSpeak = buttonElement.getAttribute('data-audio-text'); const audioTextarea = document.getElementById('audio_text'); if (audioTextarea && textToSpeak) { audioTextarea.value = textToSpeak; audioTextarea.scrollTop = 0; audioTextarea.focus(); buttonElement.classList.add('bg-green-700'); setTimeout(() => buttonElement.classList.remove('bg-green-700'), 1000); } else { console.error("Error copying to audio text."); alert("Could not copy text for audio."); } }
 function scrollToBottom(elementId) { const element = document.getElementById(elementId); if (element) { element.scrollTop = element.scrollHeight; } }
 window.addEventListener('load', () => { scrollToBottom('chat-history'); });
 document.querySelectorAll('textarea').forEach(textarea => { function autoresize() { textarea.style.height = 'auto'; textarea.style.height = textarea.scrollHeight + 'px'; } textarea.addEventListener('input', autoresize); setTimeout(autoresize, 0); });
</script>
{% endblock %}